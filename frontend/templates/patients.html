{% extends "base.html" %}
{% block content %}
<div class="card">
  <h2>Pacientes</h2>

  <div class="row" style="gap:10px;align-items:center;margin-top:8px">
    <input id="newName" placeholder="Nome do paciente">
    <input id="newDob" type="date" style="width:180px">
    <button id="btnCreate" class="btn-primary">Criar paciente</button>
    <span id="createMsg" class="form-message"></span>
  </div>

  <div id="patientsList" style="margin-top:16px"></div>
</div>

<script>
async function patientsInit(){
  const listEl = document.getElementById('patientsList');
  const msgEl = document.getElementById('createMsg');
  async function reload(){
    const r = await fetch('/api/patients');
    if (!r.ok) { listEl.innerHTML = 'Erro'; return; }
    const arr = await r.json();
    if (!arr.length) { listEl.innerHTML = '<div>Nenhum paciente</div>'; return; }
    listEl.innerHTML = '';
    arr.forEach(p=>{
      const div = document.createElement('div');
      div.className = 'patient-row';
      div.innerHTML = `<div><strong>${p.name}</strong> ${p.dob?('<small>('+p.dob+')</small>'):''}</div>
        <div class="row" style="gap:8px">
          <a href="/patients/${p.id}" class="btn">Abrir</a>
          <button class="btn-danger btnDel" data-id="${p.id}">Excluir</button>
        </div>`;
      listEl.appendChild(div);
    });
    document.querySelectorAll('.btnDel').forEach(b=>{
      b.onclick = async (ev)=>{
        const id = ev.target.dataset.id;
        if (!confirm('Excluir paciente?')) return;
        const r = await fetch(`/api/patients/${id}`, {method:'DELETE'});
        if (r.ok) reload();
      };
    });
  }
  document.getElementById('btnCreate').onclick = async ()=>{
    const name = document.getElementById('newName').value.trim();
    const dob = document.getElementById('newDob').value;
    if (!name) { msgEl.textContent = 'Nome obrigatÃ³rio.'; return; }
    const r = await fetch('/api/patients', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({name, dob, create_ficha:false})
    });
    if (!r.ok){ msgEl.textContent = 'Erro ao criar.'; return; }
    document.getElementById('newName').value='';
    document.getElementById('newDob').value='';
    msgEl.textContent = 'Criado';
    setTimeout(()=> msgEl.textContent='', 1500);
    reload();
  };
  reload();
}
patientsInit();
</script>
{% endblock %}